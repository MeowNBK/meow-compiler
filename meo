#!/bin/bash
# --- Meow Build Script üêæ ---
# T√°c gi·∫£: M√®o m·∫•t n√£o üò∫
# M·ª•c ƒë√≠ch: ƒê∆°n gi·∫£n h√≥a l·ªánh build MeowScript c√°c stage

CONFIG_DIR=".meowconfig"
CONFIG_FILE="$CONFIG_DIR/config"

# Ki·ªÉm tra xem th∆∞ m·ª•c config c√≥ t·ªìn t·∫°i ch∆∞a
if [ ! -d "$CONFIG_DIR" ]; then
    mkdir -p "$CONFIG_DIR"
fi

# H√†m ƒë·ªçc stage hi·ªán t·∫°i
get_stage() {
    if [ -f "$CONFIG_FILE" ]; then
        cat "$CONFIG_FILE"
    else
        echo "1"
    fi
}

# N·∫øu ng∆∞·ªùi d√πng nh·∫≠p "--set-stage <stage>"
if [ "$1" = "--stage" ]; then
    if [ -z "$2" ]; then
        echo "‚ö†Ô∏è  D√πng: $0 --stage <stage>"
        exit 1
    fi
    echo "$2" > "$CONFIG_FILE"
    echo "‚úÖ [INFO] ƒê√£ ƒë·∫∑t stage hi·ªán t·∫°i th√†nh: $2"
    exit 0
fi

# L·∫•y stage hi·ªán t·∫°i
STAGE="build-stage$(get_stage)"

# Ki·ªÉm tra xem file meow-vm c√≥ t·ªìn t·∫°i kh√¥ng
if [ ! -f "./bin/meow-vm" ]; then
    echo "‚ùå [ERROR] Kh√¥ng t√¨m th·∫•y ./bin/meow-vm, b·∫°n c√≥ ch·∫Øc l√† ƒëang ·ªü th∆∞ m·ª•c ƒë√∫ng kh√¥ng?"
    exit 1
fi

# Th√¥ng b√°o stage
echo "üò∫ [LOG] ƒêang build v·ªõi stage: $STAGE"

# Th·ª±c thi l·ªánh
./bin/meow-vm "$STAGE/main.meowb" "$@"
